{% extends 'presupuestos/base.html' %}
{% load tz %}
{% load filters %}

{% block extra_css %}
{{ block.super }}
{% endblock %}

{% block extra_head %}
{{ block.super }}
{% endblock %}

{% block content %}
    <div class="card mb-4">
        <div class="card-body">
            <!-- Título del presupuesto -->
            <div class="d-flex justify-content-between align-items-start mb-3">
                <div>
                    <h2 class="h4 mb-1">{{ presupuesto.nombre }}</h2>
                    <!-- Descripción (si existe) -->
                    {% if presupuesto.descripcion %}
                        <p class="card-text my-1">
                            {{ presupuesto.descripcion }}
                        </p>
                    {% endif %}
                    <p class="text-muted mb-2">
                        
                  </div>
                
                <div class="btn-group">
                    <a href="{% url 'presupuestos:editar_presupuesto' presupuesto.id %}" class="btn btn-sm btn-outline-warning" title="Editar">
                        <i class="bi bi-pencil"></i>
                    </a>
                    <a href="{% url 'presupuestos:eliminar_presupuesto' presupuesto.id %}" class="btn btn-sm btn-outline-danger" title="Eliminar">
                        <i class="bi bi-trash"></i>
                    </a>
                </div>
            </div>

            <div class="row">
                <div class="col-6">
                    <div class="d-flex align-items-center justify-content-center mb-2">
                        <div class="me-2">
                            <i class="bi bi-calendar-date fs-4 text-primary"></i>
                        </div>
                        <div>
                            <div class="text-muted small">Inicio</div>
                            <div>{{ presupuesto.fecha_inicio|date:"d/m/Y" }}</div>
                        </div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="d-flex align-items-center justify-content-center mb-2">
                        <div class="me-2">
                            <i class="bi bi-calendar-check fs-4 text-primary"></i>
                        </div>
                        <div>
                            <div class="text-muted small">Fin</div>
                            <div>{{ presupuesto.fecha_fin|date:"d/m/Y" }}</div>
                        </div>
                    </div>
                </div>
                <div class="col-12">
                    <div class="d-flex align-items-center justify-content-center">
                        <div class="me-2">
                            <i class="bi bi-currency-exchange fs-4 text-primary"></i>
                        </div>
                        <div>
                            <div class="text-muted small">Moneda</div>
                            <div>{{ presupuesto.get_moneda_display }}</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="progress mt-4" style="height: 20px;">
                <div class="progress-bar bg-{{ presupuesto.porcentaje_gastado|progress_bar_color }}" 
                     role="progressbar" 
                     style="width: {{ presupuesto.porcentaje_gastado|floatformat:0 }}%" 
                     aria-valuenow="{{ presupuesto.porcentaje_gastado|floatformat:0 }}" 
                     aria-valuemin="0" 
                     aria-valuemax="100">
                    {{ presupuesto.porcentaje_gastado|floatformat:0 }}%
                </div>
            </div>
            
            <div class="row mt-3">
                
                
                        <div class="col-3">
                            <div class="text-center texto-chico">
                                <div class="text-muted small">Inicial</div>
                                <h5 class="mb-0">{{ presupuesto.monto_total|floatformat:2 }} </h5>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="text-center texto-chico">
                                <div class="text-muted small">Gastado</div>
                                <h5 class="text-danger mb-0">-{{ total_gastos|floatformat:2 }} </h5>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="text-center texto-chico">
                                <div class="text-muted small">Ingresos</div>
                                <h5 class="text-success mb-0">+{{ total_ingresos|floatformat:2 }} </h5>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="text-center texto-chico">
                                <div class="text-muted small">Disponible</div>
                                <h5 class="text-primary mb-0">{{ monto_total_con_ingresos|floatformat:2 }} </h5>
                            </div>
                        </div>
                
                
            </div>
            
            <div class="row mt-3">
                <div class="col-12">
                    <div class="text-center">
                        <div class="text-muted small">Saldo Restante</div>
                        {% with saldo_restante=monto_total_con_ingresos|sub:total_gastos %}
                        {% widthratio saldo_restante presupuesto.monto_total 100 as porcentaje_restante %}
                        <h3 class="mb-0 {% if porcentaje_restante|add:0 > 50 %}text-success{% elif porcentaje_restante|add:0 > 25 %}text-warning{% else %}text-danger{% endif %}">
                            {{ saldo_restante|floatformat:2 }} {{ presupuesto.get_moneda_display }}
                        </h3>
                        {% endwith %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="my-4 d-flex gap-2">
        <a href="{% url 'presupuestos:crear_gasto' presupuesto_pk=presupuesto.id %}" class="btn btn-danger flex-grow-1 py-2">
            <i class="bi bi-plus-circle"></i> Ga$to
        </a>
        <a href="{% url 'presupuestos:crear_ingreso' presupuesto_pk=presupuesto.id %}" class="btn btn-success flex-grow-1 py-2">
            <i class="bi bi-plus-circle"></i> Ingreso
        </a>
    </div>

    <div class="transacciones-container">
        {% with transacciones=ingresos|add:gastos %}
        {% if transacciones %}
            {% regroup transacciones|dictsortreversed:"fecha" by fecha.date as transacciones_por_dia %}
            
            {% for dia in transacciones_por_dia %}
                <div class="dia-transacciones gastos-container">
                    <div class="dia-header p-2 mb-2 rounded text-white">
                        <h5 class="mb-0">{{ dia.grouper|date:"l, d \d\e F \d\e Y"|title }}</h5>
                    </div>
                    
                    {% for transaccion in dia.list %}
                    <div class="transaccion-item gasto-item">
                        <!-- Columna 1: Botón de eliminar -->
                        <div class="transaccion-accion gasto-accion">
                            {% if transaccion|model_name == 'gasto' %}
                            <a href="{% url 'presupuestos:eliminar_gasto' transaccion.id %}" class="btn btn-sm btn-link text-danger p-0" title="Eliminar gasto">
                                <i class="bi bi-trash-fill"></i>
                            </a>
                            {% else %}
                            <a href="{% url 'presupuestos:eliminar_ingreso' transaccion.id %}" class="btn btn-sm btn-link text-danger p-0" title="Eliminar ingreso">
                                <i class="bi bi-trash-fill"></i>
                            </a>
                            {% endif %}
                        </div>
                        
                        <!-- Columna 2: Contenido -->
                        {% if transaccion|model_name == 'gasto' %}
                        <a href="{% url 'presupuestos:ver_gasto' transaccion.id %}" class="transaccion-contenido text-decoration-none gasto-contenido">
                            <div class="transaccion-info">
                                <h6 class="transaccion-nombre gasto-nombre mb-1">{{ transaccion.nombre }}</h6>
                                <p class="transaccion-detalle text-muted small mb-1">
                                    <i class="bi bi-credit-card text-danger"></i> {{ transaccion.categoria.nombre|default:"Sin categoría" }}
                                </p>
                                {% if transaccion.descripcion %}
                                <p class="transaccion-descripcion gasto-descripcion small text-muted mb-0">
                                    {{ transaccion.descripcion|truncatechars:60 }}
                                </p>
                                {% endif %}
                            </div>
                        </a>
                        {% else %}
                        <a href="{% url 'presupuestos:ver_ingreso' transaccion.id %}" class="transaccion-contenido text-decoration-none gasto-contenido">
                            <div class="transaccion-info">
                                <h6 class="transaccion-nombre gasto-nombre mb-1">{{ transaccion.nombre }}</h6>
                                <p class="transaccion-detalle text-muted small mb-1">
                                    <i class="bi bi-cash-coin text-success"></i> Ingreso
                                </p>
                                {% if transaccion.descripcion %}
                                <p class="transaccion-descripcion gasto-descripcion small text-muted mb-0">
                                    {{ transaccion.descripcion|truncatechars:60 }}
                                </p>
                                {% endif %}
                            </div>
                        </a>
                        {% endif %}
                        
                        <!-- Columna 3: Monto y hora -->
                        <div class="transaccion-monto text-end gasto-monto">
                            {% if transaccion|model_name == 'gasto' %}
                            <div class="text-danger fw-bold">
                                -{{ transaccion.monto|floatformat:2 }} {{ transaccion.get_moneda_display }}
                            </div>
                            {% else %}
                            <div class="text-success fw-bold">
                                +{{ transaccion.monto|floatformat:2 }}
                            </div>
                            {% endif %}
                            <div class="text-muted small">
                                {{ transaccion.fecha|time:"H:i" }}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    
                    <!-- Total del día -->
                    <hr class="separador my-0">
                    <div class="p-2 mb-4 rounded">
                        <div>
                            <div class="d-flex justify-content-between">
                                {% with gastos_dia=dia.list|select_model:'gasto' %}
                                {% if gastos_dia %}
                                <span class="me-3">
                                    <p class="text-muted mb-0">Gastos:</p>
                                    <span class="text-danger fw-bold ms-1">-{{ gastos_dia|sumar_montos|floatformat:2 }}</span>
                                </span>
                                {% endif %}
                                {% endwith %}
                                
                                {% with ingresos_dia=dia.list|select_model:'ingreso' %}
                                {% if ingresos_dia %}
                                <span class="me-3">
                                    <p class="text-muted mb-0">Ingresos:</p>
                                    <span class="text-success fw-bold ms-1">+{{ ingresos_dia|sumar_montos|floatformat:2 }}</span>
                                </span>
                                {% endif %}
                                {% endwith %}
                                
                                <span>
                                <p class="text-muted mb-0">Total del día:</p>
                                {% with ingresos_dia=dia.list|select_model:'ingreso' %}
                                {% with gastos_dia=dia.list|select_model:'gasto' %}
                                {% with total_ingresos=ingresos_dia|sumar_montos total_gastos=gastos_dia|sumar_montos %}
                                {% with saldo_dia=total_ingresos|sub:total_gastos %}
                                <span class="fw-bold ms-2 {% if saldo_dia > 0 %}text-success{% elif saldo_dia < 0 %}text-danger{% endif %}">
                                    {% if saldo_dia > 0 %}+{% endif %}{{ saldo_dia|floatformat:2 }}
                                </span>
                                {% endwith %}
                                {% endwith %}
                                {% endwith %}
                                {% endwith %}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="my-4 col-12 text-center">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    No hay transacciones registradas para este presupuesto.
                </div>
            </div>
        {% endif %}
        {% endwith %}
    </div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Manejar clic en los botones de eliminar
        document.querySelectorAll('.gasto-accion a[title="Eliminar"]').forEach(function(link) {
            link.addEventListener('click', function(e) {
                // No hacer nada más, dejar que el enlace se comporte normalmente
            });
        });
    });
</script>
{% endblock %}
